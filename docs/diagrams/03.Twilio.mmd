graph TB
    %% Entrada - Message Consumers
    subgraph "Adaptadores de Entrada (Message Consumers)"
        RABBIT_CONSUMER["ğŸ° RabbitMQ Consumer<br/>@RabbitListener<br/>- pedido.creado<br/>- usuario.registrado<br/>- promocion.nueva"]
        REST_API["ğŸŒ REST API<br/>@RestController<br/>- EnvÃ­o manual<br/>- Consulta estado"]
    end
    
    %% Capa de AplicaciÃ³n
    subgraph "Capa de AplicaciÃ³n"
        MSG_HANDLER["ğŸ“‹ Message Handler<br/>@Service<br/>- Procesar eventos<br/>- Validar datos"]
        
        subgraph "DTOs"
            EVENT_DTO["ğŸ“¤ Event DTO<br/>- PedidoCreadoEvent<br/>- UsuarioRegistradoEvent"]
            SMS_DTO["ğŸ“¥ SMS Request DTO<br/>- TelÃ©fono<br/>- Mensaje<br/>- Tipo"]
            RESPONSE_DTO["ğŸ“Š Response DTO<br/>- Estado envÃ­o<br/>- ID mensaje<br/>- Timestamp"]
        end
        
        subgraph "Mappers"
            EVENT_MAPPER["ğŸ”„ Event Mapper<br/>@Mapper<br/>- Event â†’ Domain"]
            SMS_MAPPER["ğŸ”„ SMS Mapper<br/>@Mapper<br/>- DTO â†” Domain"]
        end
    end
    
    %% NÃºcleo de Dominio
    subgraph "NÃºcleo de Dominio (HexÃ¡gono)"
        subgraph "Modelos de Dominio"
            NOTIFICATION["ğŸ“¨ Notification<br/>- id<br/>- destinatario<br/>- mensaje<br/>- estado<br/>- timestamp"]
            TEMPLATE["ğŸ“„ MessageTemplate<br/>- id<br/>- tipo<br/>- plantilla<br/>- variables"]
            SMS_RESULT["ğŸ“Š SMSResult<br/>- messageId<br/>- status<br/>- errorCode"]
        end
        
        subgraph "Casos de Uso"
            SEND_SMS_UC["ğŸ“± SendSMSUseCase<br/>- Validar telÃ©fono<br/>- Aplicar template<br/>- Enviar SMS"]
            TEMPLATE_UC["ğŸ“ TemplateUseCase<br/>- Gestionar plantillas<br/>- Reemplazar variables"]
            HISTORY_UC["ğŸ“Š HistoryUseCase<br/>- Consultar historial<br/>- Generar reportes"]
        end
        
        subgraph "Puertos (Interfaces)"
            SMS_PORT["ğŸ”Œ SMS Service Port<br/>INotificationServicePort<br/>(Puerto de Entrada)"]
            PERSISTENCE_PORT["ğŸ”Œ Persistence Port<br/>INotificationPersistencePort<br/>(Puerto de Salida)"]
            SMS_PROVIDER_PORT["ğŸ”Œ SMS Provider Port<br/>ISMSProviderPort<br/>(Puerto de Salida)"]
            USER_PORT["ğŸ”Œ User Service Port<br/>IUserServicePort<br/>(Puerto de Salida)"]
        end
    end
    
    %% Adaptadores de Salida
    subgraph "Adaptadores de Salida"
        subgraph "Adaptador Twilio"
            TWILIO_ADAPTER["ğŸ“ Twilio Adapter<br/>@Component<br/>- TwilioClient<br/>- ConfiguraciÃ³n API"]
            TWILIO_CONFIG["âš™ï¸ Twilio Config<br/>- Account SID<br/>- Auth Token<br/>- From Number"]
        end
        
        subgraph "Adaptador de Persistencia"
            JPA_ADAPTER["ğŸ’¾ JPA Adapter<br/>- NotificationJpaAdapter<br/>- TemplateJpaAdapter"]
            
            subgraph "Entidades JPA"
                NOTIFICATION_ENTITY["ğŸ—ƒï¸ NotificationEntity<br/>@Entity<br/>- Logs de envÃ­o"]
                TEMPLATE_ENTITY["ğŸ—ƒï¸ TemplateEntity<br/>@Entity<br/>- Plantillas de mensaje"]
            end
            
            subgraph "Repositorios"
                NOTIFICATION_REPO["ğŸª NotificationRepository<br/>JpaRepository"]
                TEMPLATE_REPO["ğŸª TemplateRepository<br/>JpaRepository"]
            end
        end
        
        subgraph "Cliente de Microservicio"
            USER_CLIENT["ğŸ‘¥ User Service Client<br/>@FeignClient<br/>- Obtener datos usuario<br/>- Verificar telÃ©fono"]
        end
        
        DB[("ğŸ—„ï¸ Base de Datos<br/>MensajerÃ­a<br/>MySQL")]
        TWILIO_API["â˜ï¸ Twilio API<br/>Servicio Externo"]
    end
    
    %% ConfiguraciÃ³n y Seguridad
    subgraph "ConfiguraciÃ³n"
        BEAN_CONFIG["âš™ï¸ Bean Configuration<br/>@Configuration<br/>- InyecciÃ³n dependencias"]
        SECURITY_CONFIG["ğŸ” Security Config<br/>- JWT Validation<br/>- CORS Settings"]
        RABBIT_CONFIG["ğŸ° RabbitMQ Config<br/>- Queues<br/>- Exchanges<br/>- Bindings"]
    end
    
    %% Flujos principales
    RABBIT_CONSUMER --> MSG_HANDLER
    REST_API --> MSG_HANDLER
    MSG_HANDLER --> EVENT_MAPPER
    EVENT_MAPPER --> SMS_PORT
    
    SMS_PORT --> SEND_SMS_UC
    SEND_SMS_UC --> TEMPLATE_UC
    TEMPLATE_UC --> PERSISTENCE_PORT
    PERSISTENCE_PORT --> JPA_ADAPTER
    
    SEND_SMS_UC --> USER_PORT
    USER_PORT --> USER_CLIENT
    
    SEND_SMS_UC --> SMS_PROVIDER_PORT
    SMS_PROVIDER_PORT --> TWILIO_ADAPTER
    TWILIO_ADAPTER --> TWILIO_API
    
    %% Persistencia
    JPA_ADAPTER --> NOTIFICATION_ENTITY
    JPA_ADAPTER --> TEMPLATE_ENTITY
    NOTIFICATION_ENTITY --> NOTIFICATION_REPO
    TEMPLATE_ENTITY --> TEMPLATE_REPO
    NOTIFICATION_REPO --> DB
    TEMPLATE_REPO --> DB
    
    %% ConfiguraciÃ³n
    BEAN_CONFIG -.-> SEND_SMS_UC
    BEAN_CONFIG -.-> TWILIO_ADAPTER
    TWILIO_CONFIG -.-> TWILIO_ADAPTER
    RABBIT_CONFIG -.-> RABBIT_CONSUMER
    
    %% Flujo de respuesta
    TWILIO_API --> |"SMS Result"| TWILIO_ADAPTER
    TWILIO_ADAPTER --> |"SMSResult"| SEND_SMS_UC
    SEND_SMS_UC --> |"Notification"| PERSISTENCE_PORT
    PERSISTENCE_PORT --> |"Log Result"| MSG_HANDLER
    MSG_HANDLER --> |"Response"| SMS_MAPPER
    
    %% Estilos
    classDef domainCore fill:#e1f5fe,stroke:#0277bd,stroke-width:3px,color:#000000
    classDef application fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000000
    classDef infrastructure fill:#e8f5e8,stroke:#388e3c,stroke-width:3px,color:#000000
    classDef external fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000000
    classDef configuration fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000000
    
    class NOTIFICATION,TEMPLATE,SMS_RESULT,SEND_SMS_UC,TEMPLATE_UC,HISTORY_UC,SMS_PORT,PERSISTENCE_PORT,SMS_PROVIDER_PORT,USER_PORT domainCore
    class MSG_HANDLER,EVENT_DTO,SMS_DTO,RESPONSE_DTO,EVENT_MAPPER,SMS_MAPPER application
    class RABBIT_CONSUMER,REST_API,TWILIO_ADAPTER,JPA_ADAPTER,NOTIFICATION_ENTITY,TEMPLATE_ENTITY,NOTIFICATION_REPO,TEMPLATE_REPO,USER_CLIENT,DB infrastructure
    class TWILIO_API external
    class BEAN_CONFIG,SECURITY_CONFIG,RABBIT_CONFIG,TWILIO_CONFIG configuration